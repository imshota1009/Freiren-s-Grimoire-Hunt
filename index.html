<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>葬送のフリーレン - 魔導書ハント</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #a7d8ff;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            background-image: url('https://placehold.co/1920x1080/0a0a2a/ffffff?text=Mystical+Night+Sky');
            background-size: cover;
            background-position: center;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 夜空の星々を表現するアニメーション */
        .stars, .twinkling {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        .stars {
            background: #000 url(https://www.script-tutorials.com/demos/360/images/stars.png) repeat top center;
            z-index: 0;
        }
        .twinkling{
            background: transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center;
            z-index: 1;
            animation: move-twink-back 200s linear infinite;
        }
        @keyframes move-twink-back {
            from {background-position:0 0;}
            to {background-position:-10000px 5000px;}
        }

        #frieren {
            position: absolute;
            bottom: 30px;
            width: 80px;
            height: 100px;
            transition: left 0.1s linear;
            will-change: left;
            z-index: 10;
            filter: drop-shadow(0 0 10px var(--glow-color));
            /* 初期状態では非表示 */
            visibility: hidden; 
        }

        #frieren img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .grimoire {
            position: absolute;
            width: 50px;
            height: 60px;
            z-index: 5;
            animation: fall linear; /* 落下アニメーションを適用 */
            filter: drop-shadow(0 0 8px var(--glow-color));
        }

        /* 魔導書の落下アニメーション */
        @keyframes fall {
            from {
                transform: translateY(-100px); /* 画面の上外からスタート */
            }
            to {
                transform: translateY(100vh); /* 画面の下外へ */
            }
        }
        
        .grimoire-svg {
            animation: float 3s ease-in-out infinite;
        }

        /* 魔導書が揺れるアニメーション */
        @keyframes float {
            0% { transform: translateY(0px) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
            100% { transform: translateY(0px) rotate(-2deg); }
        }

        #ui-container {
            z-index: 20;
        }

        /* 収集時のパーティクルエフェクト */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--glow-color);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            animation: burst 0.7s ease-out forwards;
        }
        @keyframes burst {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2) translate(var--tx), var(--ty)); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="game-container">
        <!-- 背景アニメーション -->
        <div class="stars"></div>
        <div class="twinkling"></div>

        <!-- UI要素 -->
        <div id="ui-container" class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center p-8">
            <div id="hud" class="w-full max-w-2xl flex justify-between items-center hidden">
                <div class="bg-black/50 backdrop-blur-sm p-4 rounded-xl shadow-lg border border-cyan-400/30">
                    <span class="text-lg">スコア:</span>
                    <span id="score" class="text-2xl font-bold">0</span>
                </div>
                <div class="bg-black/50 backdrop-blur-sm p-4 rounded-xl shadow-lg border border-cyan-400/30">
                    <span class="text-lg">残り時間:</span>
                    <span id="timer" class="text-2xl font-bold">60</span>
                </div>
            </div>
            
            <!-- スタート画面 -->
            <div id="start-screen" class="text-center bg-black/60 backdrop-blur-md p-10 rounded-2xl shadow-2xl border border-cyan-400/50">
                <h1 class="text-5xl font-bold mb-2 text-cyan-200" style="text-shadow: 0 0 10px var(--glow-color);">魔導書ハント</h1>
                <p class="text-lg text-gray-300 mb-8">フリーレンと一緒に、失われた魔導書を集めよう</p>
                <button id="start-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-xl py-4 px-10 rounded-full transition-all duration-300 transform hover:scale-110 shadow-[0_0_20px_var(--glow-color)]">
                    ゲーム開始
                </button>
            </div>

            <!-- ゲームオーバー画面 -->
            <div id="end-screen" class="hidden text-center bg-black/60 backdrop-blur-md p-10 rounded-2xl shadow-2xl border border-cyan-400/50">
                <h2 class="text-4xl font-bold mb-3 text-cyan-200" style="text-shadow: 0 0 10px var(--glow-color);">タイムアップ！</h2>
                <p class="text-2xl mb-2">最終スコア: <span id="final-score" class="font-bold text-yellow-300"></span></p>
                <p id="result-message" class="text-lg text-gray-300 mb-8"></p>
                <button id="restart-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold text-xl py-4 px-10 rounded-full transition-all duration-300 transform hover:scale-110 shadow-[0_0_20px_var(--glow-color)]">
                    もう一度挑戦
                </button>
            </div>
        </div>
        
        <!-- フリーレンのキャラクター -->
        <div id="frieren">
            <!-- ↓↓↓ お好きなフリーレンの画像に差し替えてください ↓↓↓ -->
            <img src="fr_chara.png" alt="Frieren character">
            <!-- ↑↑↑ お好きなフリーレンの画像に差し替えてください ↑↑↑ -->
        </div>
    </div>
    
    <!-- ↓↓↓ BGM用のaudioタグ。srcにお好きな音楽ファイルのパスを入れてください ↓↓↓ -->
    <audio id="bgm" loop src="background_music.mp3"></audio>
    <!-- ↑↑↑ BGM用のaudioタグ。srcにお好きな音楽ファイルのパスを入れてください ↑↑↑ -->


    <script>
        const gameContainer = document.getElementById('game-container');
        const frieren = document.getElementById('frieren');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const hud = document.getElementById('hud');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const finalScoreDisplay = document.getElementById('final-score');
        const resultMessage = document.getElementById('result-message');
        const bgm = document.getElementById('bgm'); // BGM要素を取得
        
        // --- ゲームの状態管理 ---
        let score = 0;
        let timeLeft = 60;
        let gameInterval;
        let timerInterval;
        let grimoireSpawnerInterval;

        const grimoireSpawnRate = 800; // 魔導書が生成される間隔(ms)

        // --- 魔導書のSVGデータ ---
        const grimoireSVG = `
            <svg class="w-full h-full grimoire-svg" viewBox="0 0 100 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M85 110H15C9.47715 110 5 105.523 5 100V20C5 14.4772 9.47715 10 15 10H85C90.5228 10 95 14.4772 95 20V100C95 105.523 90.5228 110 85 110Z" fill="#5A3825"/>
                <path d="M85 110H15C9.47715 110 5 105.523 5 100V20C5 14.4772 9.47715 10 15 10H85C90.5228 10 95 14.4772 95 20V100C95 105.523 90.5228 110 85 110Z" stroke="#F7B538" stroke-width="6"/>
                <rect x="25" y="30" width="50" height="60" rx="5" fill="#2D231C"/>
                <path d="M50 45L65 75L35 75L50 45Z" stroke="#F7B538" stroke-width="4" stroke-linejoin="round"/>
                <circle cx="50" cy="40" r="5" fill="#F7B538"/>
            </svg>
        `;

        // --- イベントリスナー ---
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        document.addEventListener('keydown', moveFrierenKeyboard);
        
        // スマホ・マウス操作
        document.addEventListener('mousemove', moveFrierenMouse);
        document.addEventListener('touchmove', (e) => {
            e.preventDefault(); // 画面のスクロールを防ぐ
            if (e.touches.length > 0) {
                moveFrierenMouse(e.touches[0]);
            }
        }, { passive: false });


        // --- プレイヤー操作 ---
        function moveFrierenKeyboard(e) {
            let frierenLeft = frieren.offsetLeft;
            const containerWidth = gameContainer.clientWidth;
            const frierenWidth = frieren.clientWidth;

            if (e.key === 'ArrowLeft') {
                frierenLeft -= 30;
            } else if (e.key === 'ArrowRight') {
                frierenLeft += 30;
            }

            frieren.style.left = `${Math.max(0, Math.min(containerWidth - frierenWidth, frierenLeft))}px`;
        }

        function moveFrierenMouse(e) {
            const containerRect = gameContainer.getBoundingClientRect();
            const frierenWidth = frieren.clientWidth;
            let targetX = e.clientX - containerRect.left - frierenWidth / 2;
            
            frieren.style.left = `${Math.max(0, Math.min(containerRect.width - frierenWidth, targetX))}px`;
        }
        
        // --- ゲームロジック ---
        function startGame() {
            // BGM再生
            bgm.currentTime = 0;
            bgm.play().catch(error => {
                // ユーザーが画面を操作するまで再生できない場合があるため、エラーをコンソールに出力
                console.log("BGMの自動再生がブラウザにブロックされました。ユーザー操作後に再生されます。");
            });

            // 初期化
            score = 0;
            timeLeft = 60;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;
            
            // 画面切り替え
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            hud.classList.remove('hidden');
            frieren.style.visibility = 'visible'; // フリーレンを表示
            
            // 古いゲーム要素を削除
            document.querySelectorAll('.grimoire').forEach(g => g.remove());

            // ゲームループ開始
            clearInterval(gameInterval);
            gameInterval = setInterval(checkCollision, 1000 / 60);

            clearInterval(grimoireSpawnerInterval);
            grimoireSpawnerInterval = setInterval(createGrimoire, grimoireSpawnRate);

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            // BGM停止
            bgm.pause();

            clearInterval(gameInterval);
            clearInterval(timerInterval);
            clearInterval(grimoireSpawnerInterval);
            
            hud.classList.add('hidden');
            endScreen.classList.remove('hidden');
            frieren.style.visibility = 'hidden'; // フリーレンを非表示
            finalScoreDisplay.textContent = score;
            resultMessage.textContent = getResultMessage(score);
        }
        
        function getResultMessage(s) {
            if (s > 25) return "素晴らしい！まるで大魔法使いだね。";
            if (s > 15) return "すごい！なかなかの魔法使いの素質がある。";
            if (s > 5) return "うん、悪くない。もっと集められそうだ。";
            return "もっと頑張ろう。ヒンメルならそう言う。";
        }

        function createGrimoire() {
            const grimoire = document.createElement('div');
            grimoire.classList.add('grimoire');
            grimoire.innerHTML = grimoireSVG;

            const containerWidth = gameContainer.clientWidth;
            const grimoireWidth = 50;
            
            grimoire.style.left = `${Math.random() * (containerWidth - grimoireWidth)}px`;
            
            // 落下時間をランダムにして、速度に変化をつける
            const fallDuration = 4 + Math.random() * 4; // 4〜8秒
            grimoire.style.animationDuration = `${fallDuration}s`;

            gameContainer.appendChild(grimoire);
            
            // アニメーション終了後に要素を削除
            grimoire.addEventListener('animationend', () => {
                if(grimoire) {
                    grimoire.remove();
                }
            });
        }

        function checkCollision() {
            const frierenRect = frieren.getBoundingClientRect();
            document.querySelectorAll('.grimoire').forEach(grimoire => {
                const grimoireRect = grimoire.getBoundingClientRect();
                if (
                    frierenRect.left < grimoireRect.right &&
                    frierenRect.right > grimoireRect.left &&
                    frierenRect.top < grimoireRect.bottom &&
                    frierenRect.bottom > grimoireRect.top
                ) {
                    collectGrimoire(grimoire);
                }
            });
        }

        function collectGrimoire(grimoire) {
            score++;
            scoreDisplay.textContent = score;
            createParticles(grimoire.getBoundingClientRect());
            grimoire.remove();
        }

        // 収集時のエフェクト
        function createParticles(rect) {
            const particleCount = 10;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = `${centerX}px`;
                particle.style.top = `${centerY}px`;

                const angle = Math.random() * 360;
                const distance = Math.random() * 50 + 20;
                const tx = Math.cos(angle * Math.PI / 180) * distance;
                const ty = Math.sin(angle * Math.PI / 180) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);

                gameContainer.appendChild(particle);
                
                particle.addEventListener('animationend', () => {
                    particle.remove();
                });
            }
        }

    </script>
</body>
</html>

